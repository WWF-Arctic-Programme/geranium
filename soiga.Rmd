---
runtime: shiny
pagetitle1: Compatibility with AOIs
pagetitle2: Compatibility with AOIs - WWF ArcNet
pagetitle3: Decision Support and Engagement Prioritisation
pagetitle4: Soiga
pagetitle5: <a class="home" href="#">Geranium NG</a>
pagetitle: Geranium NG
author6: 
author5: "<abbr title=\"Tab panel with subtitle have to fill one line. Subtitle: 'Decision support and engagement prioritisation and visualisation tool for the Arctic Seas conservation planners'\">De...</abbr>"
author4: Decision support and engagement prioritisation
author: Decision support and engagement prioritisation and visualisation tool for the Arctic Seas conservation planners
author2: üè≠üö¢üé£üõ¢ Human use ‚öî Conservation üê≥üêªüêüüêö
author1: "[WWF ArcNet](https://arcticwwf.org/work/ocean/arcnet/)"
zzzpagetitle: Compatibility with AOIs
link-citations: yes
output1: html_document
output:
   flexdashboard::flex_dashboard:
      theme: yeti
      theme2: 
         version: 4
         bootswatch: minty
      logo: https://wwf.ru/assets/img/logo.jpg
      favicon: https://www.arcticwwf.org/favicons/favicon-32x32.png
      favicon2: https://i.stack.imgur.com/FzlQy.jpg
      orientation: columns
      vertical_layout: fill
      mathjax: true
      css:
      - site_libs/common.css
      - site_libs/flex_dashboard.css
      - include/geranium.css
      css1:
      - https://nplatonov.github.io/site_libs/common.css
      - https://nplatonov.github.io/site_libs/flex_dashboard.css
      - include/geranium.css
      navbar:
         - { title: "&nbsp;", href: "#section-welcome", align: left}
         - { title: "&nbsp;", href: "#section-admin", align: right}
         - { icon: "ion-home", href: "#section-map", align: right}
         - { icon: "ion-calculator", href: "#section-assessment", align: right}
         - { icon: "ion-help", href: "#section-manual", align: right}
         - { icon: "ion-social-github", href: "https://github.com/nplatonov/geranium", align: right, target: _blank}
         - { title: "WWF<sup>¬Æ</sup> ArcNet", zzzicon: "fa-info-circle", href: "https://arcticwwf.org/work/ocean/arcnet/", align: right, target: _blank}
output3:
   html_vignette: 
      css:
      - https://nplatonov.github.io/site_libs/common.css
      - https://nplatonov.github.io/site_libs/html_vignette.css
---

```{r init643ce921796fb94ae61005778a47b7fe, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)
```

```{js, eval=T}
const item = document.getElementsByClassName("navbar-brand");
const text = item[0].firstChild;
const link = document.createElement('a');
const cl = document.createElement('span');
link.setAttribute("href","#section-map");
link.appendChild(text);
cl.setAttribute("class","navbar-title");
cl.appendChild(link);
item[0].appendChild(cl);
const item2 = document.getElementsByClassName("navbar-author");
item[0].appendChild(item2[0]);
```

```{r header, eval=T, code=readLines("resources/header.R")}
```

```{r server, code=readLines("resources/server.R")}
```

```{r client, code=readLines("resources/client.R")}
```

```{r tabs}
hideTabs <- !is.null(rmarkdown::metadata[["author"]])
```

# Spatial query {#map data-orientation="columns" data-height=1900 `r if (hideTabs) ".hidden"`}

## {.mainbar}

### Map to select/edit regions {data-width=500 data-height=200}

```{r, eval=T & isShiny}
uiOutput("uiMap")
#leafletOutput("viewer")
#editModUI("editor")
#selectModUI("selector")
```

```{r eval=T & isShiny, fig.height=800}
output$uiMap <- renderUI({ ## editor-editModUI / selector-selectModUI / viewer-leafletOutput
   cat("renderUI -- begin:\n")
   if (input$region %in% nameEditor) {
      cat("   editor:\n")
      Sys.sleep(1)
      ret <-  editModUI("editor")
      Sys.sleep(1)
   }
   else if (T & input$predefined %in% nameClick) {
      cat("   selector:\n")
      ret <-  selectModUI("selector")
   }
   else { ## selected from list: "PAC "
      cat("   viewer:\n")
      ret <- leafletOutput("viewer")
     # ret <- textOutput("note")
   }
   cat("renderUI -- end:\n")
   ret
})
```

```{r eval=F & isShiny}
output$viewer <- renderLeaflet({
   mapViewer()
})
```

<!--
https://github.com/rstudio/flexdashboard/issues/181
-->

<!--
> NEED TO UPDATE [Conservation Action Hotspots](#welcome) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [How the assessment was made](#assessment) &nbsp;&nbsp;&nbsp;&nbsp; [Dictionary](#welcome) &nbsp;&nbsp;&nbsp;&nbsp; [FAQ](#manual)
-->


## {#inputs .no-sidebar zzzdata-width="470px" data-width=320}

### {data-height="auto"}


```{r, eval=isShiny}
width <- c("100%","472px")[2]
if (F)
   checkboxInput("customize","Customize",value=FALSE)
if (F)
   shiny::selectInput("sheet","Human use",nameInit,width=width)
if (F)
   shiny::selectInput("column","Industry",nameInit,width=width)
fillRow(flex=NA
   ,selectInput("region","Spatial query",c(names(regionSF),nameEditor)
              ,selected="PACs" # sample(names(regionSF),1)
              ,width="272px")
   ,HTML("&nbsp;&nbsp;")
   ,conditionalPanel(condition=paste0("input.xxxregion==",sQuote(nameEditor)) ## nameEditor <- "Editor"
      ,selectInput("predefined","Region from list",nameInit
                   # ,selected=nameSelector
                    ,width="182px")
   )
   ,sliderInput("omitPercent"
             # ,list(content = "My Label", position = "left")
              ,label="Omit small coverage"
              ,min=0,max=5,step=0.1,value=3
              ,width="182px"
              )
)
fillRow(flex=c(NA,NA,NA,NA,NA)
   ,selectInput("group","CF group",unname(groupList)
             # ,selected=sample(unname(groupList),1)
              ,selected=unname(ifelse(F,sample(groupList,1),groupList[1]))
              ,multiple=T
             # ,selected="Cetaceans"
              ,width="191px")
   ,HTML("&nbsp;&nbsp;")
   ,selectInput("season","Season group",seasonList
             # ,selected=ifelse(devel,sample(seasonList,1L),seasonList[1L])
              ,selected=seasonList[1L]
              ,multiple=T
              ,width="146px")
   ,HTML("&nbsp;&nbsp;")
   ,conditionalPanel(condition="!!output.debug"
      ,selectInput("activity","Activity group",c(nameAllHuman,names(industries))
                 # ,selected=ifelse(devel,sample(seasonList,1L),seasonList[1L])
                  ,selected= if (F & staffOnly) c("Infrastructure","Mining","Shipping") else nameAllHuman
                 # ,selected=nameAllHuman
                  ,multiple=T
                  ,width="121px")
      )
   )
```

:::dropdown

```{r, eval=isShiny}
fillRow(flex=c(NA,1,NA)[1]
   ,shiny::selectInput("industry","Industrial activities"
                 # ,c('No overlap'="none",'All human use'="all",industries)
                  ,"---"
                  ,multiple=T
                  ,width=width)
  # ,HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
  # ,actionLink("drawIndustry_deprecated","Update map")
)
fillRow(flex=c(NA,NA,NA),height="50%"
   ,conditionalPanel(condition="input.economy!='zzzskip'"
      ,shiny::selectInput("economy","Indexes maps"
                     ,"---"
                     ,multiple=F
                     ,width="352px")
   )
   ,HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
   ,fillCol(flex=c(NA,NA,NA)
      ,br()
      ,br()
      ,conditionalPanel(condition="input.economy!='skip'"
                       ,actionLink("drawIndustry","Update map"))
   )
)
if (F) {
  shiny::actionButton(inputId='ab1', label="location.href", 
                          icon = icon("th"), 
                          onclick ="location.href='#section-region';"
                          )
  shiny::actionButton(inputId='ab2', label="window.open", 
                          icon = icon("th"), 
                          onclick ="window.open('#section-region', '_top')"
                         # onclick ="location.href('#section-region')"
                          )
}
```

```{r, eval=F}
conditionalPanel(condition="input.economy!='none'"
      ,selectInput("economyColor","Industry colorization",unname(methodList)
                # ,selected=grep("overlap",methodList,value=TRUE)
                 ,width="352px")
)
```
:::

```{r, eval=T}
renderUI({
   if (F & file.exists(sessionFile))
      showNotification(paste("session:",format(file.mtime(sessionFile))),duration=2)
   aoi <- rvAOI()
   lab <- lab0 <- regionSF[[input$region]]$region[aoi$id]
   isPAC <- (length(lab)==1)&&(grepl("^PAC",lab))
   if (length(lab)>1)
      lab <- "Overview for selected regions"
   else
      lab <- substr(paste("Overview for",dQuote(lab),"region"),1,49)
   if (is.null(aoi))
      b2 <- navButton("Overview for Domain","#descRegion","desc",span=T)
   else
      b2 <- navButton(lab,"#descRegion","desc",span=T)
   b1 <- navButton("Selected Area Details","#crosstable","cross",span=T)
   b3 <- navButton("ArcNet Domain Details","#crosstable","cross",span=T)
   if (isPAC) {
      link <- paste0("https://wwf-arctic-programme.github.io/chicory/pac/r"
                    ,digest::digest(sprintf("region%02d"
                                     ,as.integer(gsub("\\D","",lab))),"crc32")
                    ,".html")
      b4 <- navButton("Chicory",link,color="chicory",span=T)
   }
   else
      b4 <- NULL
   b <- if (is.null(aoi)) list(b3,b2) else list(b1,b2,b4)
   navButton(b,border=T)
})
```

<!--
### {data-height="auto"}
-->

```{r, eval=FALSE}
renderUI({
   col <- if (!is.null(rvSelectIndustry())) "grey" else "grey"
   navButton("Customise my choice","#trafficlight",col,border=TRUE)
})

```{r, eval=F}
renderUI({
   lab0 <- "Human activity"
   aoi <- rvAOI()
   if (is.null(aoi))
      lab <- paste(lab0,"in the Arctic")
   else {
      lab <- regionSF[[input$region]]$region[aoi$id]
      if (length(lab)>1)
         lab <- paste(lab0,"for selected regions")
      else
         lab <- paste(lab0,"for",dQuote(lab),"region")
   }
   col <- if (is.null(rvAOI())) "orange" else "orange"
   b1 <- navButton(lab,"#list",col,border=T)
  # b2 <- navButton("Conservation Features","#list",col,span=T)
  # navButton(list(b1,b2),border=T)
   b1
})
```
```{r, eval=T}
renderUI({
   col <- if (is.null(rvAOI())) "list" else "list"
  # b1 <- navButton("Human Activities in the Arctic","#list",col,span=T)
  # b2 <- navButton("Conservation Features","#list",col,span=T)
   b1 <- navButton("All Activities","#list",col="list",span=T)
   b2 <- navButton("All Conservation Features","#list",col="list",span=T)
   navButton(list(b1,b2),border=T)
})
##~ renderUI({
   ##~ col <- if (is.null(rvAOI())) "green" else "grey"
##~ })
br()
br()
br()

```


<!--

[Industry cut (deprecated)](#industry)
&nbsp;&nbsp;&nbsp;&nbsp;
[Customise my choice (deprecated)](#trafficlight)
-->

```{r,eval=F,results='asis'}
fillRow(flex=c(1,1)
   ,renderUI({
      tagList(
         a("Conservation Action Hotspots",href="#welcome"),
         br(),
         a("How the assessment was made",href="#assessment"),
         br(),
         a("Dictionary",href="#welcome"),
         br(),
         a("****NEED TO UPDATE**** FAQ",href="#manual")
      )
   })
   ,if (F & staffOnly) renderPrint(selectionRegion()) else renderText("empty")
)
```

<!--
[Conservation Action Hotspots / Dictionary / FAQ](#welcome)  
[How the assessment was made](#assessment)  
[User Manual](#manual) `r paste(rep("&nbsp;",36),collapse="")` [Admin](#admin){.admin}
`r paste(rep("&nbsp;",6),collapse="")` [TODO](https://docs.google.com/spreadsheets/d/1Sg9i8-sUEEHS_gqB83AxU9aZ32rYnLBYJwL_50wFTfE){.admin target="_blank"}
-->


```{r eval=T & isShiny & staffOnly, results='asis'}
cat("### {data-height=\"auto\"}\n\n")
verbatimTextOutput("debug")
output$debug <- renderPrint({
   selectionRegion()
})
```

# Selected Area Details {#crosstable style="position: relative;" .zzzno-mobile .zzzno-print data-orientation="rows" `r if (hideTabs) ".hidden"`}

## Row {style="height: 50pc;" data-height=300}

### {#tabcross zzzstyle="height: 50vh;" data-width=600}

```{r, eval=T}
fillCol(flex=c(NA,1)
      # ,textOutput("verb")
       ,DT::DTOutput("cross") # %>% shinycssloaders::withSpinner()
      # ,tableOutput("smpl")
       ,uiOutput("buttonsCross")
       )
```

```{r, eval=F}
output$verb <- renderText({
   paste0(sQuote("flexdashboard")," package version: "
         ,as.character(packageVersion("flexdashboard")))
})
```{r, eval=T}
output$cross <- DT::renderDT({
   tableCross()
})
```

```{r, eval=F}
output$smpl <- renderTable(res,align="r",rownames=TRUE)
```

```{r,eval=T}
output$buttonsCross <- renderUI({
   if (F)
      fillRow(flex=c(1,NA)
         ,sliderInput("omitPercent",label="Omit small coverage",min=0,max=10,step=0.1,value=0)
         ,buttonsCross()
      )
   buttonsCross()
})
```

```{r eval=staffOnly, results='asis'}
cat("### verbose {data-width=160}\n\n")
renderPrint(selectionTables())
```

# Conservation Feature Details {#annualCF data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=500}

<!--
## Column {zstyle="height:100pc;" vertical_layout: scroll}
-->

### All compatibilities for a single CF

```{r eval=T & isShiny}
fillCol(flex=c(NA,1,NA)
       ##~ ,shiny::selectInput("cfcode","CF from crosstable",nameInit,width=width)
      # ,selectInput("cfcode","Conservation Feature"
      #             ,choices=nameInit
                  # ,choices=cfmeta$label
                  # ,selected=sample(cfmeta$label,1)
      #             ,width="680px")
      # ,textOutput("crossCol")
      ##~ # ,htmlOutput('cflink')
       ,htmlOutput('cfmeta')
      # ,verbatimTextOutput("crossSelection")
       ,DT::DTOutput("cfdata")
       ,uiOutput("buttonsCF")
      # ,HTML("&nbsp;")
       )
##~ fillCol(flex=c(NA,1)
      ##~ # ,selectInput("cfcode","Conservation Feature",cfmeta$label
      ##~ #             ,selected=sample(cfmeta$label,1),width="680px")
       ##~ ,DT::DTOutput('cfdata')
##~ )
```
```{r eval=F & isShiny}
output$crossSelection <- renderPrint({
   selectionTables()
})
```

```{r,eval=isShiny}
output$cfmeta <- renderText({
   captionCF()
})
```

```{r eval=isShiny & hlink}
output$cflink <- renderText({
   paste0("<a href=#section-cfmap>","Details","</a>")
})
```

```{r eval=isShiny}
output$cfdata <- DT::renderDT({
   tableCFdata()
})
```

```{r, eval=isShiny}
output$buttonsCF <- renderUI({
   buttonsCF()
})
```


## {data-width=200}

### Cell Comment CF {data-height="auto"}

```{r eval=T & isShiny}
renderTable({
   cellComment()
})
```

### `r renderText({
   if (is.null(rvSelectIndustry()))
      "CF Amount Distribution"
   else
      "Industry Description"
})` {data-height=200}

```{r eval=T & isShiny}
renderUI({
   industry <- rvSelectIndustry()
   if (is.null(industry)) {
      renderImage(displayCF(),deleteFile=T)
   }
   else {
      industryDescription(simple=TRUE)
   }
})
#renderImage({
#   displayCF()
#},deleteFile=T)
```

```{r, eval=T & isShiny & staffOnly, results='asis'}
cat("### staff only CF {data-height=\"auto\"}\n\n")
renderPrint({
   selectionTables()
})
```

# Human Activity Details {#annualIndustry data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=500}

### All compatibilities for a single Industry

```{r eval=T & isShiny}
fillCol(flex=c(NA,1,NA)
       ##~ ,shiny::selectInput("cfcode","CF from crosstable",nameInit,width=width)
      # ,selectInput("industry","Industry"
      #             ,choices=nameInit
                  # ,selected=sample(cfmeta$label,1)
      #             ,width=width)
      # ,textOutput("crossCol")
      ##~ # ,htmlOutput('cflink')
       ,htmlOutput('industrymeta')
      # ,verbatimTextOutput("crossSelection")
       ,DT::DTOutput("industrydata")
       ,uiOutput("buttonsIndustry")
      # ,HTML("&nbsp;")
       )
```

```{r, eval=isShiny}
output$industrymeta <- renderText({
   captionIndustry()
})
output$industrydata <- DT::renderDT({
   tableIndustryData()
})
output$buttonsIndustry <- renderUI({
   buttonsIndustry()
})
```

## Right column {data-width=200}

### Cell comment Industry {data-height="auto"}

```{r eval=T & isShiny}
renderTable({
   cellComment()
})
```

### `r renderText({
   if (!is.null(rvSelectCF()))
      "CF Amount Distribution"
   else
      "Industry Description"
})` {data-height=200}


```{r eval=T & isShiny}
renderUI({
   cf <- rvSelectCF()
  if (!is.null(cf)) {
      if (T)
         renderLeaflet({
            leafletCF(cf)
         })
      else
         renderImage({
            displayCF()
         },deleteFile=F)
   } else {
      renderUI({
         industryDescription(simple=TRUE)
      })
   }
})
```

```{r, eval=T & isShiny & staffOnly, results='asis'}
cat("### staff only CF {data-height=\"auto\"}\n\n")
renderPrint({
   selectionTables()
})
```


<!--
https://stackoverflow.com/questions/43225165/combine-in-flexdashboard-with-multiple-pages-different-types-of-vertical-layout
-->

# Reg desc {#descRegion data-orientation="columns" `r if (hideTabs) ".hidden"`}

## Column 1 - map {data-width=300}

### `r renderText({
   aoi <- rvAOI()
   if (is.null(aoi))
      "Entire area"
   else {
      lab <- regionSF[[input$region]]$region[aoi$id]
      if (length(lab)>0)
         paste(lab,collapse=", ")
      else if (length(lab)==1e8)
         paste0("<a href=\"","https://wwf-arctic-programme.github.io/chicory/pac/"
               ,"r",digest::digest(sprintf("region%02d",as.integer(gsub("\\D","",lab))),"crc"),".html"
               ,"\" target=\"_blank\">",lab,"</a>")
      else
         "Selected area"
   }
})`


```{r}
fillCol(flex=c(1,NA,NA,NA)
   ,leafletOutput("regionLeaflet")
  # ,uiOutput("uiRegionLeaflet")
      ,fixedRow(NULL
        # ,column(6
        #    ,checkboxInput("switchEPA","Show Existing Protected Areas")
        # )
        # ,column(3
        #    ,checkboxInput("switchNAO","Show NAOR")
        # )
        # ,column(3
        #    ,checkboxInput("switchNAC","Show NACR")
        # )
   )
   ,fixedRow(NULL
      ,column(2
         ,conditionalPanel(condition="input.initEPA>='0'"
           # ,actionLink("actionEPA","Show Existing Protected Areas")
            ,checkboxInput("actionEPA",HTML("Stats for <abbr title=\"Existing Protected Areas\">EPA</abbr>"))
         )
      )
      ,column(3
         ,conditionalPanel(condition="input.initEPA=='0'"
            ,actionLink("initEPA","Show Existing Protected Areas")
         )
      )
      ,column(1
         ,conditionalPanel(condition="input.actionNAO=='0'"
            ,actionLink("actionNAO","Show SR")
         )
      )
      ,column(1
        # ,checkboxInput("actionNAC",label="Show MNSR",value=FALSE)
        # ,radioButtons("actionNAC",label=NULL,choices="Show MNSR",selected=character())
         ,conditionalPanel(condition="input.actionNAC == 0" # =='0' ==null
           # ,actionLink("actionNAC","Show MNSR")
           # ,radioButtons("actionNAC",label=NULL,choices="Show MNSR",selected=character())
            ,checkboxInput("actionNAC",label="Show MNSR",value=FALSE)
         )
      )
      ,column(3
         ,conditionalPanel(condition="input.actionHU=='0'"
            ,actionLink("actionHU","Show Industrial Activities (all)")
         )
      )
       ,column(1
         ,conditionalPanel(condition="input.actionCAP=='0'"
            ,actionLink("actionCAP","Show CAPR")
         )
      )
   )
   ,renderUI({
      b1 <- navButton("Spatial query","#map",col="map",span=T)
      b2 <- navButton("Selected Area Details","#crosstable",col="cross",span=T)
      navButton(list(b1,b2))
   })
)
output$uiRegionLeaflet <- renderUI({
   req(input$actionRegion>0)
   ret <- leafletOutput("regionLeaflet")
   ret
})
output$regionLeaflet <- renderLeaflet({
   aoi <- isolate(rvAOI())
   regionAddAOI(aoi=aoi,addOverlay=TRUE)
})
```

## Column 2 Region Details {data-width=300}

### {data-header="Basic Statistics" data-height="auto"}


```{r, eval=T}
DT::renderDT({
   switchDomain(FALSE)
   result <- rvRegionStats()
   print("0306a")
   str(result)
   print("0306b")
   regionTable(result)
})
```

### {data-header="Conservation Concern Level by Activity" data-height=180}

```{r, eval=T}
fillCol(flex=c(NA,1)
   ,HTML("Conservation Concern Level by Activity")
   ,renderPlotly({
      metrics <- rvRegionStats()
      req(metrics$nCF>0)
      regionPlotIndustry(metrics,relative=input$relative)
   })
)
```

### {data-header="Seasonal histogram" data-height=160}

```{r, eval=T}
fillRow(flex=c(10,NA,14)
   ,fillCol(flex=c(1,NA,1)
      ,fillCol(flex=c(NA,1)
         ,HTML("Concern Indexes")
         ,DT::renderDT({
            result <- rvRegionStats()
            req(result$nCF>0)
            regionConcernIndices(result)
         })
      )
      ,br()#HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
      ,{if (F)
         fillCol(flex=c(NA,1)
            ,HTML("Most Critical Months")
            ,DT::renderDT({
               result <- rvRegionStats()
               req(result$nCF>0)
               res <- result[['SC']] |> data.frame() |> t()
               if (input$relative)
                  res <- res/result$'maxNAC'*100
               res <- t(res) |> as.data.frame(check.names=FALSE)
               da <- DT::datatable(res,escape=F
                                  ,colnames="" # "<abbr title='Season of concern'>SC</abbr>"
                                  ,selection="none"
                                  ,options=list(dom="t",ordering=F),class="compact")
               DT::formatRound(da,colnames(res),1)
            })
         )
      else
         fillCol(flex=c(NA,1)
            ,HTML("Activity Indexes")
            ,DT::renderDT({
               aoi <- rvAOI()
               ctable <- rvActivityStat()
              # DT::datatable(data.frame(id=1,value="dummy"))
               regionActivityIndices(ctable,aoi)
            })
           # ,HTML("Industrial Activities (PPU) = 21 (average for ArcNet = 4)")
           # ,HTML("Conservation action priority (PPU) = 14 (average for ArcNet = 3")
           # ,HTML("TODO: Conservation action priority (PPU = 194 (13451 sum for ArcNet))")
         )
      }
   )
   ,HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
   ,fillCol(flex=c(NA,1)
      ,HTML("Conservation Concern Level by Month")
      ,renderPlotly({
         result <- rvRegionStats()
         req(result$nCF>0)
         regionPlotSeason(result,relative=input$relative)
      })
   )
)
```

### {data-height="auto"}

```{r}
downloadLink("downloadMetrics","Download interim data for MNSCF and MNSIA")
HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
downloadLink("instantReport","Instant Report (template)")
output$downloadMetrics <- downloadHandler(
   filename=function() {
      aoi <- rvAOI()
      if (is.null(aoi))
         return("Global metrics.xlsx")
      lab <- regionSF[[input$region]]$region[aoi$id]
      str(aoi$id)
      str(regionSF[[input$region]])
      lab <- strsplit(sort(lab),split="\\s") |>
         do.call(c,args=_) |>
         unique() |>
         paste(collapse=" ")
      paste0(lab," metrics.xlsx")
   }
   ,content=function(file) {
      interim <- rvRegionMetrics()
      req(!is.null(interim$cover))
     # str(interim)
      dNAM <- cbind(interim$cover,interim$NAM)
      dNAO <- cbind(interim$cover,interim$NAO)
      dNAC <- cbind(interim$cover,interim$NAC)
     # str(res)
     # res <- iris
      xlsx::write.xlsx(dNAM,file,sheetName="ref",append=FALSE)
      xlsx::write.xlsx(dNAO,file,sheetName="SC",append=TRUE)
      xlsx::write.xlsx(dNAC,file,sheetName="MNSC",append=TRUE)
   }
)
output$instantReport <- downloadHandler(
   filename=function() {
      aoi <- rvAOI()
      if (is.null(aoi))
         lab <- "Global"
      lab <- regionSF[[input$region]]$region[aoi$id]
      paste0("metrics-",digest::digest(lab,"crc32"),".docx")
   }
   ,content=function(file) {
      cat("instantReport (content):\n")
      fext <- gsub(".*\\.(.+$)","\\1",basename(file))
      oformat <- {
         if (fext=="docx")
               bookdown::word_document2(toc=FALSE
                                       ,number_sections=FALSE
                                       )
         else if (fext=="pdf")
               bookdown::pdf_document2(toc=FALSE
                                      ,number_sections=FALSE
               )
         else if (fext=="html")
               bookdown::html_document2(toc=FALSE
                                       ,number_sections=FALSE
               )
         else
            NULL
      }
      ooptions <- {
         if ((fext=="docx")&&(file.exists("instant-ref.docx")))
            list(reference_docs="instant-ref.docx")
         else
            NULL
      }
      interim <- rvRegionMetrics()
      req(!is.null(interim$cover))
      str(interim$result)
     # print(getwd())
      fname <- file.path(root,"report","instantTemplate.Rmd")
      # tempReport <- file.path(tempdir(),fname)
     # file.copy(fname,tempReport,overwrite=TRUE)
      showModal(modalDialog(title = "Compiling in progress","Please wait"
                       ,size="s",easyClose = TRUE,footer = NULL))
      ret <- try(rmarkdown::render(fname
                       ,output_file=file
                       ,output_format=oformat
                       ,output_options=ooptions
                       ,params=list(metrics=interim
                                   ,aoi=rvAOI()
                                   ,ctable=rvActivityStat()
                                   ,dpath=file.path(root,"request"))
                       ,envir=new.env(parent=globalenv())))
      str(ret)
      removeModal()
      ret
   }
)
```

## Top Concern {data-width=50}

###

```{r, eval=T}
fillCol(flex=c(NA,1)
  # ,HTML("Top NACR CF")
   ,HTML(paste0("<abbr title=","'Proportion of maximal Conservation Concern Level'"
               ,">Top CFs by Concern</abbr>"))
   ,DT::renderDT({
     # result <- rvRegionStats() ## dummy returning; renew table
      switchDomain(FALSE)
      ctable <- rvActivityStat()
      req(nrow(ctable)>0)
      ntable <- ctable[order(ctable$NAC,decreasing=TRUE),c("CF name","NAC"),drop=FALSE]
      ntable <- ntable[!is.nan(ntable$NAC),]
      ntable <- ntable[ntable$NAC>=50,]
      req(nrow(ntable)>0)
      rownames(ntable) <- paste0("<abbr title='",ntable$'CF name',"'>",rownames(ntable),"</abbr>")
      ntable <- ntable[,"NAC",drop=FALSE]
      colnames(ntable) <- paste0("<abbr title='Proportion of maximal MNSR'>MNSR</abbr>")
      res <- data.frame(cf=rownames(ntable))
      da <- DT::datatable(ntable,escape=F
                         ,colnames=NULL
                         ,selection="none"
                        # ,extension=c("Scroller")
                         ,options=list(dom="t",ordering=F,pageLength=50
                                     # ,scroller=T,scrollY="calc(50vh - 105px)"
                                      )
                         ,class="compact"
                         )
      da <- DT::formatRound(da,colnames(ntable),0)
      da
   })
)
```

## quantilies {data-width=50 .hidden}

### {data-header="TOP IND"}

```{r, eval=FALSE}
fillCol(flex=c(NA,1)
   ,HTML("Activities of Concern")
   ,DT::renderDT({
     # res <- rvRegionStats()[['TOP IND']] |> data.frame() |> t()
      result <- rvRegionStats()
      req(result$nCF>0)
      res <- result[['IND']]
      if (input$relative)
         res <- res/result$'maxNAC'*100
      LH <- quantile(res,probs=max(input$levelNAC)*1e-2)
      res <- sort(res[res>=LH],decreasing=TRUE) |> data.frame() |> t()
      cname <- colnames(res)
      lname <- industryName(cname)
      colnames(res) <- paste0("<abbr title='",lname,"'>",cname,"</abbr>")
      res <- t(res) |> as.data.frame(check.names=FALSE)
      da <- DT::datatable(res,escape=F
                        # ,colnames=paste0("Activities of Concern"
                        #                 ," (",max(input$levelNAC),")"
                        #                 )
                         ,colnames=NULL
                         ,selection="none"
                         ,extension=c("Scroller")
                         ,options=list(dom="t",ordering=F,pageLength=50
                                      ,scroller=T,scrollY="calc(50vh - 105px)"
                                      )
                         ,class="compact"
                         )
      da <- DT::formatRound(da,colnames(res),1)
      da
   })
)
```

### {data-header="IND LC"}

```{r, eval=FALSE}
fillCol(flex=c(NA,1)
   ,HTML("Activities of Least Concern")
   ,DT::renderDT({
     # res <- rvRegionStats()[['LC IND']] |> data.frame() |> t()
      result <- rvRegionStats()
      req(result$nCF>0)
      res <- result[['IND']]
      if (input$relative)
         res <- res/result$'maxNAC'*100
      LH <- quantile(res,probs=min(input$levelNAC)*1e-2)
      res <- sort(res[res<=LH],decreasing=FALSE) |> data.frame() |> t()
      cname <- colnames(res)
      lname <- industryName(cname)
      colnames(res) <- paste0("<abbr title='",lname,"'>",cname,"</abbr>")
      res <- t(res) |> as.data.frame(check.names=FALSE)
      da <- DT::datatable(res,escape=F
                        # ,colnames=paste0("Activities of Least Concern"
                        #               #  ," (",min(input$levelNAC),")"
                        #                 )
                         ,colnames=NULL
                         ,selection="none"
                         ,extension=c("Scroller")
                         ,options=list(dom="t",ordering=F,pageLength=50
                                      ,scroller=T,scrollY="calc(50vh - 105px)"
                                      )
                         ,class="compact"
                         )
      da <- DT::formatRound(da,colnames(res),1)
      da
   })
)
```

# CF desc {#descCF .zzzhidden data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=500}

### Metadata

```{r eval=T & isShiny}
fillCol(flex=c(NA,1,1)
  # ,renderTable({
   ,DT::renderDT({
      metadataCF()
   })
   ,renderUI({
      b <- buttonsTemplate()
      b <- b[grep("(cf.*overview|industry.*list)",names(b),invert=TRUE)]
      navButton(b)
   })
   ,if (staffOnly) renderPrint({
      selectionTables()
   }) else HTML("&nbsp;")
)
```

## {data-width=400}

### Map

```{r eval=T & isShiny}
  # renderImage(displayCF(),deleteFile=T)
   renderLeaflet(leafletCF())
```

# I desc {#descIndustry .zzzhidden data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=300}

### Industry map 

```{r eval=T & isShiny}
if (staffOnly) {
   fillCol(flex=c(1,NA)
      ,leafletOutput("industryMap")
     # ,checkboxInput("industryDesc","Show map (it is not quick)",value=FALSE)
     # ,actionLink("industryDesc","Show map (it is not quick)")
      ,renderPrint(selectionTables())
   )
} else {
   fillCol(flex=c(1)
      ,leafletOutput("industryMap")
     # ,checkboxInput("industryDesc","Show map (it is not quick)",value=FALSE)
     # ,actionLink("industryDesc","Show map (it is not quick)")
   )
}
output$industryMap <- renderLeaflet({
  # req(input$industryDesc)
   displayIndustry()
})
```


## {data-width=360}

### Industry description


```{r eval=T & isShiny}
fillCol(flex=c(1,NULL,NA)
   ,renderUI({
      industryDescription(simple=FALSE)
   })
   ##~ ,if (staffOnly) renderPrint(
      ##~ selectionTables()
   ##~ )
   ,renderUI({
      b <- buttonsTemplate()
      b <- b[grep("(indus.*overview|cf.*list)",names(b),invert=TRUE)]
      navButton(b)
   })
)
```

# Lists... {#list data-orientation="rows" `r if (hideTabs) ".hidden"`}

## {.failured data-height="auto"}

### Conservation Features {data-height=600}

```{r, eval=T & isShiny}
fillCol(flex=1,DT::DTOutput("onlyCF"))
output$onlyCF <- DT::renderDT({
   tableOnlyCF()
})
```

```{r, eval=F & isShiny}
output$switchCF <- renderUI({
   switchCF()
})
```

### Activities in the Arctic {data-height=400}

```{r, eval=T & isShiny}
fillCol(flex=1,DT::DTOutput("onlyIndustry"))
output$onlyIndustry <- DT::renderDT({
   tableOnlyIndustry()
})
```

```{r, eval=F & isShiny}
output$switchIndustry <- renderUI({
   switchIndustry()
})
```

## {data-height=50}
   
```{r, eval=T & isShiny}
fillCol(flex=NA,uiOutput("buttonsList"))
output$buttonsList <- renderUI({
   buttonsList()
})
```

# Comments {#comment data-orientation="columns" `r if (T & hideTabs) ".hidden"`}

## {data-width=100}

### `r renderText(rvSelectCF())`/`r renderText(industryCode(rvSelectIndustry()))` interaction {#iceconc}

```{r}
fillCol(flex=NA
   ,iceConcTable() |> renderTable()
   ,iceConcRule() |> renderTable()
   ,renderImage(iceConcHuman(),deleteFile=T)
   ,renderImage(iceConcCF(),deleteFile=T)
   ,renderImage(iceConcMonthly(),deleteFile=T)
)
```

## {data-width=100}

### Initial comments {data-height="auto"}

```{r}
renderTable({
   cellComment()
})
```

### {data-height="auto"}

```{r}
DT::renderDT({
##~ renderPrint({
   cf <- rvSelectCF()
   industry <- rvSelectIndustry()
   str(cf)
   str(industry)
   da <- rvHumanUseCF()
   da <- da[da[[1]] %in% industry,]
   da <- cbind(CF=paste0("<abbr title='",CFName(cf),"'>",cf,"</abbr>")
              ,Industry=paste0("<abbr title='",industry,"'>",rownames(da),"</abbr>")
              ,da[,-1])
  # saveRDS(da,"C:/tmp/interim.rds")
   b <- DT::datatable(da,rownames=!TRUE,escape=FALSE,selection="none"
                      # ,extensions="Scroller"
                       ,options=list(NULL
                                    ,ordering=F
                                   # ,scroller=T
                                   # ,scrollY="calc(100vh - 265px)"
                                    ,pageLength=nrow(da)
                                    ,dom="t"
                                    )
                       )
   b <- DT::formatStyle(b,colnames(da)
                     ,backgroundColor=DT::styleEqual(c('1','2','3'
                                                      ,kwdGreen,kwdYellow,kwdRed
                                                     )
                                           ,c(clrLUT,clrLUT))
                     ,backgroundSize='95% 18pt'
                     ,backgroundRepeat='no-repeat'
                     ,backgroundPosition='center'  
                     )
   b
})
```

### Discussion

```{r}
renderTable({
   rvCommentTable()
})
```

### {data-height="auto"}

```{r}
uiOutput("buttonsComment")
output$buttonsComment <- renderUI({
   buttonsComment()
})
```

## {data-width=60}

### Leave a comment {data-height="240"}

```{r}
# fillRow(flex=c(2,1)
#   ,fillCol(flex=NA
       textAreaInput("opinion","Suggestion",""
                     ,placeholder="Your review, remarks, suggestions - any opinion"
                     ,width="calc(100% - 0px)"
                     ,height="200px"
                     )
  # )
  # ,fillCol(flex=c(NA,1,NA)
      textInput("author","Your name","",placeholder="Your name"
                ,width="calc(100% - 0px)")
      br()
      actionLink("submit","Submit")
  # )
#)
```
> Your name, your comment will be visible for everyone. Your comment will be moderated. It can be edited or deleted by Geranium managers.



```{r, eval=T, child="include/welcome.Rmd"}
```

### Staff only quick navigation {data-width=160}

[Spatial Query](#map)  
[Cross details](#crosstable)  
[CF details](#annualCF)  
[Industry details](#annualIndustry)  
[CF overview](#descCF)     
[Industry overview](#descIndustry)  
[Region overview](#descRegion)  
[Lists CF and Indutries](#list)  

----

`r paste0(basename(sessionFile),": ",file.mtime(sessionFile))`  
`r paste0(basename(commentFile),": ",file.mtime(commentFile))`  
`r paste0(basename(configFile),": ",file.mtime(configFile))`  
`r paste0("quickStart",": ",as.character(quickStart))`  
`r paste0("root",": ",root)`  


```{r, eval=F}
sliderInput("omitPercent",label="Omit small coverage",min=0,max=10,step=0.1,value=0)
```

```{r, eval=T, child="include/assessment.Rmd"}
```

```{r, eval=T, child="include/manual.Rmd"}
```

# {#admin .hidden .failured}

## {data-width=80}

###

### Deep colouring {data-height="auto"}

```{r}
   sliderInput("ncolor",label="Number of categories in maps"
               ,min=5,max=11,step=1,value=config$ncolor
               )
```

### Verbosing {data-height="auto"}

```{r}
   sliderInput("sleepValue",label="Pausing Value, ms"
               ,min=0,max=1000,step=10,value=config$sleepValue
               )
```


## {data-width=180}

### Comments

```{r}
checkboxInput("comment","Comments are available",value=config$comment)
downloadLink("downloadComment","Download comments")
fileext <- c(".csv",".xlsx")[2]
output$downloadComment <- downloadHandler(
   filename=function() {
      paste0("comments-",format(Sys.time(),"%Y%m%d-%H%M"),fileext)
   }
   ,content=function(file) {
      req(comment_exists())
      da <- comment_read()
      req(nrow(da)>0)
      switch(fileext 
            ,'.csv'=write.csv(da,file)
            ,'.xlsx'=xlsx::write.xlsx(da,file,sheetName="comments",append=FALSE)
            )
   }
)  
br()
br()
DT::renderDT({
   req(comment_exists())
   da <- comment_read()
   da <- da[order(da$Time,decreasing=TRUE),]
   req(nrow(da)>0)
   b <- DT::datatable(da,rownames="")
   b
})
```

## {data-width=120}

### NAC Multipliers

```{r}
sliderInput("mulNAR",label="Multiplyer for red cells"
           ,min=0,max=100,step=1,value=config$concern[1]
           )
sliderInput("mulNAY",label="Multiplyer for yellow cells"
           ,min=0,max=100,step=1,value=config$concern[2]
           )
sliderInput("mulNAG",label="Multiplyer for green cells"
           ,min=0,max=100,step=1,value=config$concern[3]
           )
if (F) {
   actionLink("rebuildNAC","Apply changes")
   br()
   HTML("Application will be restarted with initialization during 1-2 mins.")
}
```

### Misc {data-height="auto"}

:::dropup

```{r}
checkboxInput("relative","Relative NAC",value=config$relative)
sliderInput("levelNAC",label="Quantilies (%) for IND LC (low) and TOP IND (high)"
           ,min=0,max=100,step=1,value=config$quantile
           )
conditionalPanel(condition="2==2 || input.industry!='none' || input.economy!='none'"
      ,selectInput("coloring","Colorization",unname(methodList)
                # ,selected=grep("overlap",methodList,value=TRUE)
                 ,width="342px"
                 )
)
```
:::
