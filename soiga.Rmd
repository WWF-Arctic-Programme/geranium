---
runtime: shiny
pagetitle1: Compatibility with AOIs
pagetitle2: Compatibility with AOIs - WWF ArcNet
pagetitle3: Decision Support and Engagement Prioritisation
pagetitle4: Soiga
pagetitle5: <a class="home" href="#">Geranium NG</a>
pagetitle: Geranium
author6: 
author5: "<abbr title=\"Tab panel with subtitle have to fill one line. Subtitle: 'Decision support and engagement prioritisation and visualisation tool for the Arctic Seas conservation planners'\">De...</abbr>"
author4: Decision support and engagement prioritisation
author: Decision support and engagement prioritisation and visualisation tool for the Arctic Seas conservation planners
author2: üè≠üö¢üé£üõ¢ Human use ‚öî Conservation üê≥üêªüêüüêö
author1: "[WWF ArcNet](https://arcticwwf.org/work/ocean/arcnet/)"
zzzpagetitle: Compatibility with AOIs
link-citations: yes
output1: html_document
output:
   flexdashboard::flex_dashboard:
      theme: yeti
      theme2: 
         version: 4
         bootswatch: minty
      logo1: https://wwf.ru/assets/img/logo.jpg
      logo2: https://www.arcticwwf.org/favicons/favicon-32x32.png
      logo: https://www.worldwildlife.org/assets/structure/unique/logo-c562409bb6158bf64e5f8b1be066dbd5983d75f5ce7c9935a5afffbcc03f8e5d.png
      favicon: https://www.worldwildlife.org/assets/structure/unique/logo-c562409bb6158bf64e5f8b1be066dbd5983d75f5ce7c9935a5afffbcc03f8e5d.png
      favicon1: https://www.arcticwwf.org/favicons/favicon-32x32.png
      favicon2: https://i.stack.imgur.com/FzlQy.jpg
      orientation: columns
      vertical_layout: fill
      mathjax: true
      css:
      - site_libs/common.css
      - site_libs/flex_dashboard.css
      - include/geranium.css
      css1:
      - https://nplatonov.github.io/site_libs/common.css
      - https://nplatonov.github.io/site_libs/flex_dashboard.css
      - include/geranium.css
      navbar:
         - { title: "&nbsp;", href: "#section-welcome", align: left}
        # - { title: "&nbsp;", href: "#section-admin", align: right}
         - { icon: "ion-home", href: "#section-map", align: right}
         - { icon: "ion-calculator", href: "#section-assessment", align: right}
         - { icon: "ion-help", href: "#section-manual", align: right}
         - { icon: "ion-social-github", href: "https://github.com/", align: right, target: _blank}
         - { title: "WWF<sup>¬Æ</sup> ArcNet", zzzicon: "fa-info-circle", href: "https://arcticwwf.org/work/ocean/arcnet/", align: right, target: _blank}
output3:
   html_vignette: 
      css:
      - https://nplatonov.github.io/site_libs/common.css
      - https://nplatonov.github.io/site_libs/html_vignette.css
---

```{r init643ce921796fb94ae61005778a47b7fe, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)
```

```{js, eval=T}
const item = document.getElementsByClassName("navbar-brand");
const text = item[0].firstChild;
const link = document.createElement('a');
const cl = document.createElement('span');
link.setAttribute("href","#section-map");
link.appendChild(text);
cl.setAttribute("class","navbar-title");
cl.appendChild(link);
item[0].appendChild(cl);
const item2 = document.getElementsByClassName("navbar-author");
item[0].appendChild(item2[0]);
```

```{r header, eval=T, code=readLines("resources/header.R")}
```

```{r server, evel=T, code=readLines("resources/server.R")}
```

```{r deprecated, eval=F, code=readLines("resources/server_deprecated.R")}
```

```{r tables, eval=T, code=readLines("resources/tables.R")}
```

```{r output, eval=T, code=readLines("resources/output.R")}
```

```{r client, eval=T, code=readLines("resources/client.R")}
```

```{r tabs}
hideTabs <- !is.null(rmarkdown::metadata[["author"]])
```

# Spatial query {#map data-orientation="columns" data-height=1900 `r if (hideTabs) ".hidden"`}

## {.mainbar}

### Map to select/edit regions {data-width=500 data-height=200}

```{r uimap, eval=T & isShiny}
uiOutput("uiMap")
#leafletOutput("viewer")
#editModUI("editor")
#selectModUI("selector")
```

```{r uimapOutput, eval=T & isShiny, fig.height=800}
output$uiMap <- renderUI({ ## editor-editModUI / selector-selectModUI / viewer-leafletOutput
   cat("renderUI -- begin:\n")
   if (F)
      NULL
   else if (T & input$predefined %in% nameClick) { ## selector should be earlier editor
      cat("   selector:\n")
      ret <-  selectModUI("selector")
   }
   else if (input$region %in% nameEditor) {
      cat("   editor:\n")
      ret <-  editModUI("editor")
   }
   else { ## selected from list: "PAC "
      cat("   viewer:\n")
      ret <- leafletOutput("viewer")
     # ret <- textOutput("note")
   }
   cat("renderUI -- end:\n")
   ret
})
```

<!--
```{r eval=F & isShiny}
output$viewer <- renderLeaflet({
   mapViewer()
})
```
-->

<!--
https://github.com/rstudio/flexdashboard/issues/181
-->

<!--
> NEED TO UPDATE [Conservation Action Hotspots](#welcome) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [How the assessment was made](#assessment) &nbsp;&nbsp;&nbsp;&nbsp; [Dictionary](#welcome) &nbsp;&nbsp;&nbsp;&nbsp; [FAQ](#manual)
-->

```{r staffmap, eval=T & isShiny & staffOnly, results='asis'}
# cat("### staff only Map {data-height=\"auto\"}\n\n")
cat("## {data-width=\"300\"}\n\n### staff only Map\n\n")
renderPrint({
   selectionTables()
})
```


## {#inputs .no-sidebar zzzdata-width="470px" data-width=400}

### {data-height="auto"}


```{r inputs, eval=isShiny}
width <- c("100%","472px")[2]
if (F)
   checkboxInput("customize","Customize",value=FALSE)
if (F)
   shiny::selectInput("sheet","Human use",nameInit,width=width)
if (F)
   shiny::selectInput("column","Industry",nameInit,width=width)
fillRow(flex=NA
   ,selectInput("region","Spatial query",c(names(regionSF),nameEditor)
              ,selected="PACs" # sample(names(regionSF),1)
              ,width="212px")
   ,HTML("&nbsp;&nbsp;")
   ,conditionalPanel(condition=paste0("input.xxxregion==",sQuote(nameEditor)) ## nameEditor <- "Editor"
      ,selectInput("predefined","Region from list",nameInit
                   # ,selected=nameSelector
                    ,width="182px") ## 'leaflet.extras' of 'leafpm'
   )
  # ,actionButton("upload","Upload region",width="64px")
   ,HTML("&nbsp;&nbsp;")
   ,sliderInput("omitPercent"
             # ,list(content = "My Label", position = "left")
              ,label="Omit small coverage"
              ,min=0,max=5,step=0.1,value=3
              ,width="112px"
              )
   ,conditionalPanel(condition="2==2" # "!!output.debug"
      ,fillRow(flex=NA
         ,HTML("&nbsp;&nbsp;")
         ,conditionalPanel(condition="!output.pinEntered"
            ,passwordInput("pwd","PIN",width="64px")
         )
         ,conditionalPanel(condition="!!output.pinEntered"
            ,fillCol(flex=NA
               ,renderText({
                  a <- rvUserName()
                  if (nchar(a)>15)
                     a <- paste0(substr(a,1,14),"\u2026")
                  a
                })
               ,HTML("&nbsp;&nbsp;")
              # ,actionLink("reset","Reset (debug)")
               ,actionLink("reset",renderText({
                  if (nchar(rvUserName())>0) "Logout" else "Unauthorized"
               }),width="60px")
            )
         )
      )
   )
)
fillRow(flex=NA
   ,conditionalPanel(condition="2==2" # "!!output.debug"
      ,fillRow(flex=NA
         ,selectInput("group3",c("Conservation Feature (CF) Group","CF group3 (draft term)")[1]
                    # ,choices=nameAllCF['3']
                     ,choices=unname(groupList)
                    # ,choices=groupListCF()
                    # ,selected=unname(ifelse(F,sample(groupList,1),groupList[1]))
                     ,selected=nameAllCF['3']
                     ,multiple=T
                    # ,selected="Cetaceans"
                    ,width="191px")
         ,HTML("&nbsp;&nbsp;")
      )
   )
   ,selectInput("season","Season group",seasonList
             # ,selected=ifelse(devel,sample(seasonList,1L),seasonList[1L])
              ,selected=seasonList[1L]
              ,multiple=T
              ,width="146px")
   ,conditionalPanel(condition="2==2" # "!!output.debug"
      ,fillRow(flex=NA
         ,HTML("&nbsp;&nbsp;")
         ,div(class="latent"
            ,selectInput("activity","Activity group",c(nameAllHuman,names(industries))
                       # ,selected=ifelse(devel,sample(seasonList,1L),seasonList[1L])
                        ,selected= if (F & staffOnly) c("Infrastructure","Mining","Shipping") else nameAllHuman
                       # ,selected=nameAllHuman
                        ,multiple=T
                        ,width="121px")
            )
         )
      )
   )
```

:::dropdown
```{r, eval=isShiny}
fillRow(flex=c(NA,1,NA)[1]
   ,shiny::selectInput("industry","Industrial activities"
                 # ,c('No overlap'="none",'All human use'="all",industries)
                  ,"---"
                  ,multiple=T
                  ,width=width)
  # ,HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
  # ,actionLink("drawIndustry_deprecated","Update map")
)
```
:::
::: {.dropup .latent}
```{r, eval=isShiny}
conditionalPanel(condition="2==2" # "!!output.debug"
   ,fillRow(flex=NA
      ,shiny::selectInput("group2","CF species"
                    # ,c('No overlap'="none",'All CF'="all","CF new field")
                     ,"---"
                     ,multiple=T
                     ,width="221px")
      ,HTML("&nbsp;&nbsp;")
      ,shiny::selectInput("group1","CF parameters"
                     ,"---"
                     ,multiple=T
                     ,width="246px")
   )
)
```
:::
:::dropup
```{r, eval=isShiny}
conditionalPanel(condition="2==2" # "!!output.debug")
    ,shiny::selectInput("group0","Individual CFs"
                   ,"---"
                   ,multiple=T
                   ,width=width)
)
```
:::
:::dropup
```{r, eval=isShiny}
fillRow(flex=c(NA,NA,NA),height="50%"
   ,conditionalPanel(condition="input.economy!='zzzskip'"
      ,shiny::selectInput("economy","Indexes maps"
                     ,"---"
                     ,multiple=F
                     ,width="352px")
   )
   ,HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
   ,fillCol(flex=c(NA,NA,NA)
      ,br()
      ,br()
      ,conditionalPanel(condition="input.economy!='skip'"
                       ,actionLink("drawIndustry","Update map"))
   )
)
if (F) {
  shiny::actionButton(inputId='ab1', label="location.href", 
                          icon = icon("th"), 
                          onclick ="location.href='#section-region';"
                          )
  shiny::actionButton(inputId='ab2', label="window.open", 
                          icon = icon("th"), 
                          onclick ="window.open('#section-region', '_top')"
                         # onclick ="location.href('#section-region')"
                          )
}
```

<!--
```{r, eval=F}
conditionalPanel(condition="input.economy!='none'"
      ,selectInput("economyColor","Industry colorization",unname(methodList)
                # ,selected=grep("overlap",methodList,value=TRUE)
                 ,width="352px")
)
```
-->

:::

```{r, eval=T}
renderUI({
   if (F & file.exists(sessionFile))
      showNotification(paste("session:",format(file.mtime(sessionFile))),duration=2)
   aoi <- rvAOI()
   lab <- lab0 <- rvRegionSF()[[input$region]]$region[aoi$id]
   isPAC <- (length(lab)==1)&&(grepl("^PAC",lab))
   if (length(lab)>1)
      lab <- "Overview for selected regions"
   else
      lab <- substr(paste("Overview for",dQuote(lab),"region"),1,49)
   if (is.null(aoi))
      b2 <- navButton("Overview for ArcNet Area","#descRegion","desc",span=T)
   else
      b2 <- navButton(lab,"#descRegion","desc",span=T)
   b1 <- navButton("Selected Area Details","#crosstable","cross",span=T)
   b3 <- navButton("ArcNet Area Details","#crosstable","cross",span=T)
   if (isPAC) {
      link <- paste0("https://wwf-arctic-programme.github.io/chicory/pac/r"
                    ,digest::digest(sprintf("region%02d"
                                     ,as.integer(gsub("\\D","",lab))),"crc32")
                    ,".html")
      b4 <- navButton("Chicory",link,color="chicory",span=T)
   }
   else
      b4 <- NULL
   b <- if (is.null(aoi)) list(b3,b2) else list(b1,b2,b4)
   navButton(b,border=T)
})
```

<!--
### {data-height="auto"}
-->

<!--
```{r, eval=FALSE}
renderUI({
   col <- if (!is.null(rvSelectIndustry())) "grey" else "grey"
   navButton("Customise my choice","#trafficlight",col,border=TRUE)
})
-->

<!--
```{r, eval=F}
renderUI({
   lab0 <- "Human activity"
   aoi <- rvAOI()
   if (is.null(aoi))
      lab <- paste(lab0,"in the Arctic")
   else {
      lab <- rvRegionSF()[[input$region]]$region[aoi$id]
      if (length(lab)>1)
         lab <- paste(lab0,"for selected regions")
      else
         lab <- paste(lab0,"for",dQuote(lab),"region")
   }
   col <- if (is.null(rvAOI())) "orange" else "orange"
   b1 <- navButton(lab,"#list",col,border=T)
  # b2 <- navButton("Conservation Features","#list",col,span=T)
  # navButton(list(b1,b2),border=T)
   b1
})
```
-->


```{r, eval=T}
renderUI({
  # col <- if (is.null(rvAOI())) "list" else "list"
   b1 <- navButton("All Activities","#list",col="list",span=T)
   b2 <- navButton("All Conservation Features","#list",col="list",span=T)
   b3 <- navButton("Lists...","#list",col="list",span=T)
   if (is.null(rvAOI())) {
     b3 <- NULL
   }
   else {
     # switchDomain(FALSE)
     # renderText("Lists of CFs or/and Activities unavailable with selection(s)")
      b1 <- b2 <- NULL
   }
   navButton(list(b1,b2,b3),border=T)
})
##~ renderUI({
   ##~ col <- if (is.null(rvAOI())) "green" else "grey"
##~ })
# br()
# br()
# br()

```


<!--
[Industry cut (deprecated)](#industry)
&nbsp;&nbsp;&nbsp;&nbsp;
[Customise my choice (deprecated)](#trafficlight)
-->

<!--
```{r,eval=F,results='asis'}
fillRow(flex=c(1,1)
   ,renderUI({
      tagList(
         a("Conservation Action Hotspots",href="#welcome"),
         br(),
         a("How the assessment was made",href="#assessment"),
         br(),
         a("Dictionary",href="#welcome"),
         br(),
         a("****NEED TO UPDATE**** FAQ",href="#manual")
      )
   })
   ,if (F & staffOnly) renderPrint(selectionRegion()) else renderText("empty")
)
```
-->

<!--
[Conservation Action Hotspots / Dictionary / FAQ](#welcome)  
[How the assessment was made](#assessment)  
[User Manual](#manual) `r paste(rep("&nbsp;",36),collapse="")` [Admin](#admin){.admin}
`r paste(rep("&nbsp;",6),collapse="")` [TODO](https://docs.google.com/spreadsheets/d/1Sg9i8-sUEEHS_gqB83AxU9aZ32rYnLBYJwL_50wFTfE){.admin target="_blank"}
-->


```{r eval=T & isShiny & staffOnly, results='asis'}
cat("### {data-height=\"auto\"}\n\n")
verbatimTextOutput("debug")
output$debug <- renderPrint({
   selectionRegion()
})
```

<!--
```{r, eval=F & staffOnly}
shinyApp(
  ui = fluidPage(), # fillPage(),
  server = function(input, session, output) {
    session$onSessionEnded(stopApp)
  }
)
```
-->


# Selected Area Details {#crosstable style="position: relative;" .zzzno-mobile .zzzno-print data-orientation="rows" `r if (hideTabs) ".hidden"`}

## Row {style="height: 50pc;" data-height=300}

### {#tabcross zzzstyle="height: 50vh;" data-width=600}

```{r, eval=T}
fillCol(flex=c(NA,1)
      # ,textOutput("verb")
       ,DT::DTOutput("cross") # %>% shinycssloaders::withSpinner()
      # ,tableOutput("smpl")
       ,uiOutput("buttonsCross")
       )
```

<!--
```{r, eval=F}
output$verb <- renderText({
   paste0(sQuote("flexdashboard")," package version: "
         ,as.character(packageVersion("flexdashboard")))
})
-->

```{r, eval=T}
output$cross <- DT::renderDT({
   tableCross()
})
```

<!--
```{r, eval=F}
output$smpl <- renderTable(res,align="r",rownames=TRUE)
```
-->

```{r,eval=T}
output$buttonsCross <- renderUI({
   if (F)
      fillRow(flex=c(1,NA)
         ,sliderInput("omitPercent",label="Omit small coverage",min=0,max=10,step=0.1,value=0)
         ,buttonsCross()
      )
   buttonsCross()
})
```

```{r eval=staffOnly, results='asis'}
cat("### verbose Cross {data-width=160}\n\n")
renderPrint(selectionTables())
```

# Conservation Feature Details {#annualCF data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=500}

<!--
## Column {zstyle="height:100pc;" vertical_layout: scroll}
-->

### All compatibilities for a single CF

```{r eval=T & isShiny}
fillCol(flex=c(NA,1,NA)
       ##~ ,shiny::selectInput("cfcode","CF from crosstable",nameInit,width=width)
      # ,selectInput("cfcode","Conservation Feature"
      #             ,choices=nameInit
                  # ,choices=cfmeta$label
                  # ,selected=sample(cfmeta$label,1)
      #             ,width="680px")
      # ,textOutput("crossCol")
      ##~ # ,htmlOutput('cflink')
       ,htmlOutput('cfmeta')
      # ,verbatimTextOutput("crossSelection")
       ,DT::DTOutput("cfdata")
       ,uiOutput("buttonsCF")
      # ,HTML("&nbsp;")
       )
##~ fillCol(flex=c(NA,1)
      ##~ # ,selectInput("cfcode","Conservation Feature",cfmeta$label
      ##~ #             ,selected=sample(cfmeta$label,1),width="680px")
       ##~ ,DT::DTOutput('cfdata')
##~ )
```
<!--
```{r eval=F & isShiny}
output$crossSelection <- renderPrint({
   selectionTables()
})
```
-->


```{r,eval=isShiny}
output$cfmeta <- renderText({
   captionCF()
})
```

```{r eval=isShiny & hlink}
output$cflink <- renderText({
   paste0("<a href=#section-cfmap>","Details","</a>")
})
```

```{r eval=isShiny}
output$cfdata <- DT::renderDT({
   tableCFdata()
})
```

```{r, eval=isShiny}
output$buttonsCF <- renderUI({
   buttonsCF()
})
```


## {data-width=200}

### Cell Comment CF {data-height="auto"}

```{r eval=T & isShiny}
renderTable({
   cellComment()
})
```

### `r renderText({
   if (is.null(rvSelectIndustry()))
      "CF Amount Distribution"
   else
      "Activity Description (industry is not selected)"
})` {data-height=200}

```{r eval=T & isShiny}
renderUI({
   industry <- rvSelectIndustry()
   if (is.null(industry)) {
      renderImage(displayCF(),deleteFile=T)
   }
   else {
      industryDescription(simple=TRUE)
   }
})
#renderImage({
#   displayCF()
#},deleteFile=T)
```

```{r, eval=T & isShiny & staffOnly, results='asis'}
cat("### staff only CF {data-height=\"auto\"}\n\n")
renderPrint({
   selectionTables()
})
```

# Human Activity Details {#annualIndustry data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=500}

### All compatibilities for a single Activity

```{r eval=T & isShiny}
fillCol(flex=c(NA,1,NA)
       ##~ ,shiny::selectInput("cfcode","CF from crosstable",nameInit,width=width)
      # ,selectInput("industry","Industry"
      #             ,choices=nameInit
                  # ,selected=sample(cfmeta$label,1)
      #             ,width=width)
      # ,textOutput("crossCol")
      ##~ # ,htmlOutput('cflink')
       ,htmlOutput('industrymeta')
      # ,verbatimTextOutput("crossSelection")
       ,DT::DTOutput("industrydata")
       ,uiOutput("buttonsIndustry")
      # ,HTML("&nbsp;")
       )
```

```{r, eval=isShiny}
output$industrymeta <- renderText({
   captionIndustry()
})
output$industrydata <- DT::renderDT({
   tableIndustryData()
})
output$buttonsIndustry <- renderUI({
   buttonsIndustry()
})
```

## Right column {data-width=200}

### Cell comment Activity {data-height="auto"}

```{r eval=T & isShiny}
renderTable({
   cellComment()
})
```

### `r renderText({
   if (!is.null(rvSelectCF()))
      "CF Amount Distribution"
   else
      "Activity Description (CF is not selected)"
})` {data-height=200}


```{r eval=T & isShiny}
renderUI({
   cf <- rvSelectCF()
  if (!is.null(cf)) {
      if (T)
         renderLeaflet({
            leafletCF(cf)
         })
      else
         renderImage({
            displayCF()
         },deleteFile=F)
   } else {
      renderUI({
         industryDescription(simple=TRUE)
      })
   }
})
```

```{r, eval=T & isShiny & staffOnly, results='asis'}
cat("### staff only CF {data-height=\"auto\"}\n\n")
renderPrint({
   selectionTables()
})
```


<!--
https://stackoverflow.com/questions/43225165/combine-in-flexdashboard-with-multiple-pages-different-types-of-vertical-layout
-->

# Reg desc {#descRegion data-orientation="columns" `r if (hideTabs) ".hidden"`}

## Column 1 - map {data-width=300}

### `r renderText({
   aoi <- rvAOI()
   if (is.null(aoi))
      "Entire area"
   else {
      lab <- rvRegionSF()[[input$region]]$region[aoi$id]
      if (length(lab)>0)
         paste(lab,collapse=", ")
      else if (length(lab)==1e8)
         paste0("<a href=\"","https://wwf-arctic-programme.github.io/chicory/pac/"
               ,"r",digest::digest(sprintf("region%02d",as.integer(gsub("\\D","",lab))),"crc32"),".html"
               ,"\" target=\"_blank\">",lab,"</a>")
      else
         "Selected area"
   }
})`


```{r}
condJS <- ifelse(F,"==false",">=0")
fillCol(flex=c(1,NA,NA,NA)
   ,leafletOutput("regionLeaflet")
  # ,uiOutput("uiRegionLeaflet")
      ,fixedRow(NULL
        # ,column(6
        #    ,checkboxInput("switchEPA","Show Existing Protected Areas")
        # )
        # ,column(3
        #    ,checkboxInput("switchNAO","Show NAOR")
        # )
        # ,column(3
        #    ,checkboxInput("switchNAC","Show NACR")
        # )
   )
   ,fixedRow(NULL
      ,column(2
         ,conditionalPanel(condition="2==2"
           # ,actionLink("actionEPA","Show Existing Protected Areas")
            ,checkboxInput("actionEPA",HTML("Stats for <abbr title=\"Existing Protected Areas\">EPA</abbr>"))
         )
      )
      ,column(3
         ,conditionalPanel(condition=paste0("input.initEPA",condJS) ## ==false
           # ,actionLink("initEPA","Show Existing Protected Areas")
            ,checkboxInput("initEPA","Show Existing Protected Areas")
         )
      )
      ,column(1
         ,conditionalPanel(condition=paste0("input.actionNAO",condJS) ## ==false
           # ,actionLink("actionNAO","Show SR")
            ,checkboxInput("actionNAO",label="Show SR",value=FALSE)
         )
      )
      ,column(1
        # ,checkboxInput("actionNAC",label="Show MNSR",value=FALSE)
        # ,radioButtons("actionNAC",label=NULL,choices="Show MNSR",selected=character())
         ,conditionalPanel(condition=paste0("input.actionNAC",condJS) # =='0' ==null ==false
           # ,actionLink("actionNAC","Show MNSR")
           # ,radioButtons("actionNAC",label=NULL,choices="Show MNSR",selected=character())
            ,checkboxInput("actionNAC",label="Show MNSR",value=FALSE)
         )
      )
      ,column(1
         ,conditionalPanel(condition=paste0("input.actionCAP",condJS) ## ==false
           # ,actionLink("actionCAP","Show CAPR")
            ,checkboxInput("actionCAP",label="Show CAPR",value=FALSE)
         )
      )
      ,column(3
         ,conditionalPanel(condition=paste0("input.actionHU",condJS) ## ==false
           # ,actionLink("actionHU","Show Industrial Activities (all)")
            ,checkboxInput("actionHU",label="Industrial Activities (all)",value=FALSE)
         )
      )
   )
   ,renderUI({
      b1 <- navButton("Spatial query","#map",col="map",span=T)
      b2 <- navButton("Lists...","#list",col="list",span=T)
      b3 <- navButton("Selected Area Details","#crosstable",col="cross",span=T)
      navButton(list(b1,b2,b3))
   })
)
output$uiRegionLeaflet <- renderUI({
  # req(input$actionRegion>0)
   ret <- leafletOutput("regionLeaflet")
   ret
})
output$regionLeaflet <- renderLeaflet({
   if (count>1) {
      showNotification(paste("Unexpected behaviour. Count is",count),duration=3)
     # Sys.sleep(10)
   }
   aoi <- isolate(rvAOI())
   map <- regionAddAOI(aoi=aoi,addOverlay=TRUE)
  # map <- indexMap(aoi=aoi)
  # map <- conflictBasemap()
  # if (!is.null(aoi))
  #    map <- indexMap(map,"AOI")
  # map <- indexMap(map)
  # if (is.null(exchange$region))
  #    map <- indexMap()
  # else
  #    map <- exchange$region
   count <<- count+1L
   print(c('count.regionLeaflet'=count))
   map
})
```

## Column 2 Region Details {data-width=300}

### {data-header="Basic Statistics" data-height="auto"}


```{r, eval=showHist}
DT::renderDT({
   switchDomain(FALSE)
   result <- rvRegionStats()
   regionTable(result)
})
```

### {data-header="Conservation Concern Level by Activity" data-height=180}

```{r, eval=showHist}
fillCol(flex=c(NA,1)
   ,HTML("Conservation Concern Level by Activity")
   ,renderPlotly({
      metrics <- rvRegionStats()
      req(metrics$nCF>0)
      regionPlotIndustry(metrics,relative=input$relative)
   })
)
```

### {data-header="Seasonal histogram" data-height=160}

```{r, eval=showHist}
fillRow(flex=c(10,NA,14)
   ,fillCol(flex=c(1,NA,1)
      ,fillCol(flex=c(NA,1)
         ,HTML("Concern Indexes")
         ,DT::renderDT({
            result <- rvRegionStats()
            req(result$nCF>0)
            regionConcernIndices(result)
         })
      )
      ,br()#HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
      ,{if (F)
         fillCol(flex=c(NA,1)
            ,HTML("Most Critical Months")
            ,DT::renderDT({
               result <- rvRegionStats()
               req(result$nCF>0)
               res <- result[['SC']] |> data.frame() |> t()
               if (input$relative)
                  res <- res/result$'maxNAC'*100
               res <- t(res) |> as.data.frame(check.names=FALSE)
               da <- DT::datatable(res,escape=F
                                  ,colnames="" # "<abbr title='Season of concern'>SC</abbr>"
                                  ,selection="none"
                                  ,options=list(dom="t",ordering=F),class="compact")
               DT::formatRound(da,colnames(res),1)
            })
         )
      else
         fillCol(flex=c(NA,1)
            ,HTML("Activity Indexes")
            ,DT::renderDT({
               aoi <- rvAOI()
               ctable <- rvCrossTable()
              # DT::datatable(data.frame(id=1,value="dummy"))
               regionActivityIndices(ctable,aoi)
            })
           # ,HTML("Industrial Activities (PPU) = 21 (average for ArcNet = 4)")
           # ,HTML("Conservation action priority (PPU) = 14 (average for ArcNet = 3")
           # ,HTML("TODO: Conservation action priority (PPU = 194 (13451 sum for ArcNet))")
         )
      }
   )
   ,HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
   ,fillCol(flex=c(NA,1)
      ,HTML("Conservation Concern Level by Month")
      ,renderPlotly({
         result <- rvRegionStats()
         req(result$nCF>0)
         regionPlotSeason(result,relative=input$relative)
      })
   )
)
```

### {data-height="auto"}

```{r, eval=showHist}
downloadLink("downloadMetrics","Download interim data for MNSCF and MNSIA")
HTML("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")
downloadLink("instantReport","Instant Report")
output$downloadMetrics <- downloadHandler(
   filename=function() {
      aoi <- rvAOI()
      if (is.null(aoi))
         return("Global metrics.xlsx")
      lab <- rvRegionSF()[[input$region]]$region[aoi$id]
      str(aoi$id)
      str(rvRegionSF()[[input$region]])
      lab <- strsplit(sort(lab),split="\\s") |>
         do.call(c,args=_) |>
         unique() |>
         paste(collapse=" ")
      paste0(lab," metrics.xlsx")
   }
   ,content=function(file) {
      interim <- rvRegionMetrics()
      req(!is.null(interim$cover))
     # str(interim)
      dNAM <- cbind(interim$cover,interim$NAM)
      dNAO <- cbind(interim$cover,interim$NAO)
      dNAC <- cbind(interim$cover,interim$NAC)
     # str(res)
     # res <- iris
      xlsx::write.xlsx(dNAM,file,sheetName="ref",append=FALSE)
      xlsx::write.xlsx(dNAO,file,sheetName="SC",append=TRUE)
      xlsx::write.xlsx(dNAC,file,sheetName="MNSC",append=TRUE)
   }
)
output$instantReport <- downloadHandler(
   filename=function() {
      aoi <- rvAOI()
      if (is.null(aoi))
         lab <- "Global"
      lab <- rvRegionSF()[[input$region]]$region[aoi$id]
      paste0("metrics-",digest::digest(lab,"crc32"),".docx")
   }
   ,content=function(file) {
      cat("instantReport (content):\n")
      fext <- gsub(".*\\.(.+$)","\\1",basename(file))
      oformat <- {
         if (fext=="docx")
               bookdown::word_document2(toc=FALSE
                                       ,number_sections=FALSE
                                       )
         else if (fext=="pdf")
               bookdown::pdf_document2(toc=FALSE
                                      ,number_sections=FALSE
               )
         else if (fext=="html")
               bookdown::html_document2(toc=FALSE
                                       ,number_sections=FALSE
               )
         else
            NULL
      }
      ooptions <- {
         if ((fext=="docx")&&(file.exists("instant-ref.docx")))
            list(reference_docs="instant-ref.docx")
         else
            NULL
      }
      interim <- rvRegionMetrics()
      req(!is.null(interim$cover))
      str(interim$result)
     # print(getwd())
      fname <- file.path(root,"report","instantTemplate.Rmd")
      # tempReport <- file.path(tempdir(),fname)
     # file.copy(fname,tempReport,overwrite=TRUE)
      showModal(modalDialog(title = "Compiling in progress","Please wait"
                       ,size="s",easyClose = TRUE,footer = NULL))
      ret <- try(rmarkdown::render(fname
                       ,output_file=file
                       ,output_format=oformat
                       ,output_options=ooptions
                       ,params=list(metrics=interim
                                   ,aoi=rvAOI()
                                   ,ctable=rvCrossTable()
                                   ,dpath=file.path(root,"request"))
                       ,envir=new.env(parent=globalenv())))
      str(ret)
      removeModal()
      ret
   }
)
```

## Top Concern {data-width=50}

###

```{r, eval=showHist}
fillCol(flex=c(NA,1)
  # ,HTML("Top NACR CF")
   ,HTML(paste0("<abbr title=","'Proportion of maximal Conservation Concern Level'"
               ,">Top CFs by Concern</abbr>"))
   ,DT::renderDT({
     # result <- rvRegionStats() ## dummy returning; renew table
      switchDomain(FALSE)
      ctable <- rvCrossTable()
      req(nrow(ctable)>0)
      ntable <- ctable[order(ctable$NAC,decreasing=TRUE),c("CF name","NAC"),drop=FALSE]
      ntable <- ntable[!is.nan(ntable$NAC),]
      ntable <- ntable[ntable$NAC>=50,]
      req(nrow(ntable)>0)
      rownames(ntable) <- paste0("<abbr title='",ntable$'CF name',"'>",rownames(ntable),"</abbr>")
      ntable <- ntable[,"NAC",drop=FALSE]
      colnames(ntable) <- paste0("<abbr title='Proportion of maximal MNSR'>MNSR</abbr>")
      res <- data.frame(cf=rownames(ntable))
      da <- DT::datatable(ntable,escape=F
                         ,colnames=NULL
                         ,selection="none"
                        # ,extension=c("Scroller")
                         ,options=list(dom="t",ordering=F,pageLength=50
                                     # ,scroller=T,scrollY="calc(50vh - 105px)"
                                      )
                         ,class="compact"
                         )
      da <- DT::formatRound(da,colnames(ntable),0)
      da
   })
)
```

## quantilies {data-width=50 .hidden}

### {data-header="TOP IND"}

<!--
```{r, eval=FALSE}
fillCol(flex=c(NA,1)
   ,HTML("Activities of Concern")
   ,DT::renderDT({
     # res <- rvRegionStats()[['TOP IND']] |> data.frame() |> t()
      result <- rvRegionStats()
      req(result$nCF>0)
      res <- result[['IND']]
      if (input$relative)
         res <- res/result$'maxNAC'*100
      LH <- quantile(res,probs=max(input$levelNAC)*1e-2)
      res <- sort(res[res>=LH],decreasing=TRUE) |> data.frame() |> t()
      cname <- colnames(res)
      lname <- industryName(cname)
      colnames(res) <- paste0("<abbr title='",lname,"'>",cname,"</abbr>")
      res <- t(res) |> as.data.frame(check.names=FALSE)
      da <- DT::datatable(res,escape=F
                        # ,colnames=paste0("Activities of Concern"
                        #                 ," (",max(input$levelNAC),")"
                        #                 )
                         ,colnames=NULL
                         ,selection="none"
                         ,extension=c("Scroller")
                         ,options=list(dom="t",ordering=F,pageLength=50
                                      ,scroller=T,scrollY="calc(50vh - 105px)"
                                      )
                         ,class="compact"
                         )
      da <- DT::formatRound(da,colnames(res),1)
      da
   })
)
```
-->

### {data-header="IND LC"}

<!--
```{r, eval=FALSE}
fillCol(flex=c(NA,1)
   ,HTML("Activities of Least Concern")
   ,DT::renderDT({
     # res <- rvRegionStats()[['LC IND']] |> data.frame() |> t()
      result <- rvRegionStats()
      req(result$nCF>0)
      res <- result[['IND']]
      if (input$relative)
         res <- res/result$'maxNAC'*100
      LH <- quantile(res,probs=min(input$levelNAC)*1e-2)
      res <- sort(res[res<=LH],decreasing=FALSE) |> data.frame() |> t()
      cname <- colnames(res)
      lname <- industryName(cname)
      colnames(res) <- paste0("<abbr title='",lname,"'>",cname,"</abbr>")
      res <- t(res) |> as.data.frame(check.names=FALSE)
      da <- DT::datatable(res,escape=F
                        # ,colnames=paste0("Activities of Least Concern"
                        #               #  ," (",min(input$levelNAC),")"
                        #                 )
                         ,colnames=NULL
                         ,selection="none"
                         ,extension=c("Scroller")
                         ,options=list(dom="t",ordering=F,pageLength=50
                                      ,scroller=T,scrollY="calc(50vh - 105px)"
                                      )
                         ,class="compact"
                         )
      da <- DT::formatRound(da,colnames(res),1)
      da
   })
)
```
-->

# CF desc {#descCF .zzzhidden data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=500}

### CF Metadata

```{r eval=T & isShiny}
fillCol(flex=c(NA,1,1)
  # ,renderTable({
   ,DT::renderDT({
      metadataCF()
   })
   ,renderUI({
      b <- buttonsTemplate()
      b <- b[grep("(cf.*overview|industry.*list)",names(b),invert=TRUE)]
      navButton(b)
   })
   ,if (staffOnly) renderPrint({
      selectionTables()
   }) else HTML("&nbsp;")
)
```

## {data-width=400}

### Map

```{r eval=T & isShiny}
  # renderImage(displayCF(),deleteFile=T)
   renderLeaflet(leafletCF())
```

# I desc {#descIndustry .zzzhidden data-orientation="columns" `r if (hideTabs) ".hidden"`}

## {data-width=300}

### Activity map 

```{r eval=T & isShiny}
if (staffOnly) {
   fillCol(flex=c(1,NA,NA)
      ,leafletOutput("industryMap")
      ,checkboxInput("industryDesc","Show map (it is not quick)",value=FALSE)
     # ,actionLink("industryDesc","Show map (it is not quick)")
      ,renderPrint(selectionTables())
   )
} else {
   fillCol(flex=c(1)
      ,leafletOutput("industryMap")
     # ,checkboxInput("industryDesc","Show map (it is not quick)",value=FALSE)
     # ,actionLink("industryDesc","Show map (it is not quick)")
   )
}
output$industryMap <- renderLeaflet({
   if (staffOnly)
      req(input$industryDesc)
   displayIndustry()
})
```


## {data-width=360}

### Activity description


```{r eval=T & isShiny}
fillCol(flex=c(1,NULL,NA)
   ,renderUI({
      industryDescription(simple=FALSE)
   })
   ##~ ,if (staffOnly) renderPrint(
      ##~ selectionTables()
   ##~ )
   ,renderUI({
      b <- buttonsTemplate()
      b <- b[grep("(indus.*overview|cf.*list)",names(b),invert=TRUE)]
      navButton(b)
   })
)
```

# Lists... {#list data-orientation="rows" `r if (hideTabs) ".hidden"`}

## {.failured data-height="auto"}

### Conservation Features {data-height=600}

```{r, eval=T & isShiny}
fillCol(flex=1,DT::DTOutput("onlyCF"))
output$onlyCF <- DT::renderDT({
   tableOnlyCF()
})
```

<!--
```{r, eval=F & isShiny}
output$switchCF <- renderUI({
   switchCF()
})
```
-->

### Activities in the Arctic {data-height=400}

```{r, eval=T & isShiny}
fillCol(flex=1,DT::DTOutput("onlyIndustry"))
output$onlyIndustry <- DT::renderDT({
   tableOnlyIndustry()
})
```

```{r eval=staffOnly, results='asis'}
cat("### staff only lists {data-width=300}\n\n")
renderPrint(selectionTables())
```

<!--
```{r, eval=F & isShiny}
output$switchIndustry <- renderUI({
   switchIndustry()
})
```
-->

## {data-height=50}
   
```{r, eval=T & isShiny}
fillCol(flex=NA,uiOutput("buttonsList"))
output$buttonsList <- renderUI({
   buttonsList()
})
```

# Comments {#comment data-orientation="columns" `r if (T & hideTabs) ".hidden"`}

## {data-width=100}

### `r renderText(rvSelectCF())`/`r renderText(industryCode(rvSelectIndustry()))` interaction {#iceconc}

```{r, eval=T | showComment}

checkboxInput("iceConcDetails","Show details for this interaction",value=FALSE)
conditionalPanel(condition="!!input.iceConcDetails"
   ,fillCol(flex=NA
     # ,iceConcTable() |> renderTable() ## deprecated
      ,iceConcRule() |> renderTable()
      ,renderImage(iceConcHuman(),deleteFile=T)
      ,renderImage(iceConcCF(),deleteFile=T)
      ,renderImage(iceConcMonthly(),deleteFile=T)
   )
)
```

## {data-width=100}

### Initial comments {data-height="auto"}

```{r, eval=T | showComment}
renderTable({
   cellComment()
})
```

### {data-height="auto"}

```{r, eval=T | showComment}
DT::renderDT({
  ##~ renderPrint({
   commentList()
})
```

### Discussion

```{r, eval=T | showComment}
renderTable({
   rvCommentTable()
})
```

### {data-height="auto"}

```{r, eval=T | showComment}
uiOutput("buttonsComment")
output$buttonsComment <- renderUI({
   buttonsComment()
})
```

## {data-width=60}

### `r renderText(ifelse(isTRUE(rvAdmin()),"Comments management","Leave a comment"))` {data-height="240"}

```{r, eval=T | showComment}
conditionalPanel(condition="!output.admin"
   ,fillCol(flex=NA
      ,textAreaInput("opinion","Suggestion",""
                     ,placeholder="Your review, remarks, suggestions - any opinion"
                     ,width="calc(100% - 0px)"
                     ,height="200px"
                     )
      ,conditionalPanel(condition="!output.authorized"
         ,textInput("author","Your name","",placeholder="Your name"
                   ,width="calc(100% - 0px)")
      )
      ,br()
      ,actionLink("submit","Submit")
   )
)
```
> Your name, your comment will be visible for everyone. Your comment will be moderated. It can be edited or deleted by Geranium managers.



```{r, eval=staffOnly, child="include/welcome.Rmd"}
```

### Staff only quick navigation {data-width=160}

[Spatial Query](#map)  
[Cross details](#crosstable)  
[CF details](#annualCF)  
[Industry details](#annualIndustry)  
[CF overview](#descCF)     
[Industry overview](#descIndustry)  
[Region overview](#descRegion)  
[Lists CF and Indutries](#list)  

----

`r paste0(basename(sessionFile),": ",file.mtime(sessionFile))`  
`r paste0(basename(commentFile),": ",file.mtime(commentFile))`  
`r paste0(basename(configFile),": ",file.mtime(configFile))`  
`r paste0("quickStart",": ",as.character(quickStart))`  
`r paste0("root",": ",root)`  

<!--
```{r, eval=F}
sliderInput("omitPercent",label="Omit small coverage",min=0,max=10,step=0.1,value=0)
```
-->

```{r assessment, eval=T, child="include/assessment.Rmd"}
```

```{r manual, eval=T, child="include/manual.Rmd"}
```

# `r renderText(rvUserInitials())` {#admin .nothidden .failured}

## {data-width=80}

### `r renderText(ifelse(rvAdmin(),"User management","Customization"))` {data-height=100}

```{r}
cond1 <- "input.userNew == '' & input.userName != ''"
conditionalPanel(condition="!!output.admin"
   ,fillRow(flex=NA
      ,conditionalPanel(condition="input.userNew == '' & output.userEmpty == false"
         ,selectInput("userName","User name",choices="",width="180px")
      )
      ,HTML("&nbsp;&nbsp;")
      ,conditionalPanel(condition=cond1
         ,fillRow(flex=NA
            ,selectInput("userLevel","User level"
                        ,choices=c(0L,1L,2L,9L)
                        ,selected=0L,width="60px")
            ,HTML("&nbsp;&nbsp;")
            ,actionLink("userForgot","PIN")
         )
      )
   )
   ,conditionalPanel(condition=cond1
      ,renderPrint({
         user <- rvUserInd()
         str(user)
        # ind <- rvAuthorized()
        # ind <- match(input$userName,user$name)
         
      })
   )
   ,fillRow(flex=NA
      ,textInput("userNew","New user",width="180px")
      ,HTML("&nbsp;&nbsp;")
      ,conditionalPanel(condition=cond1
         ,actionLink("userRemove","Remove user")
      )
      ,conditionalPanel(condition="input.userNew != ''"
         ,actionLink("userAdd","Add user")
      )
   )
)
conditionalPanel(condition="!output.admin & output.authorized"
   ,fillCol(flex=NA
      ,fileInput("customAOI",label="Your AOI",buttonLabel="Browse",placeholder=NULL
               ,accept=c(".geojson",".geojson.gz",".shp.zip")
               ,width="100%")
      ,renderImage({
         req(input$customAOI)
         fname <- input$customAOI$datapath
         session_grid(NULL)
         a <- ursa:::spatialize(fname) |> spatial_geometry()
         ret <- glance(a,pointsize=20,blank="white",coast.fill="#00000010")
         list(src=ret,width="100%",'height'="100%",'max-width'="100%"
          ,'object-fit'="scale-down",class="propersize")
      },deleteFile=TRUE)
   )
)
```


### Settings {data-height="auto"}

```{r}
conditionalPanel(condition="!!output.authorized"
   ,fillCol(flex=NA
      ,sliderInput("ncolor",label="Number of categories in maps"
                  ,min=5,max=11,step=1,value=config$ncolor
                  )
      ,sliderInput("levelNAC",label="Quantilies (%) for IND LC (low) and TOP IND (high)"
                 ,min=0,max=100,step=1,value=config$quantile
                 )
   )
)
conditionalPanel(condition="1==2" # !!output.debug & !!output.admin"
   ,renderPrint({
      r <- input$allComments_rows_selected
      da <- rvAllComments()[r,]
      print(c(selected=r))
      str(da)
   })
)
```


## {data-width=180}

### All Comments

```{r}
conditionalPanel(condition="!!output.admin"
   ,fillCol(flex=NA
      ,DT::DTOutput("allComments")
      ,uiOutput("onlyCommentButton")
   )
)
fileext <- c(".csv",".xlsx")[2]
output$downloadComment <- downloadHandler(
   filename=function() {
      paste0("comments-",format(Sys.time(),"%Y%m%d-%H%M"),fileext)
   }
   ,content=function(file) {
      da <- rvAllComments()
      switch(fileext 
            ,'.csv'=write.csv(da,file)
            ,'.xlsx'=xlsx::write.xlsx(da,file,sheetName="comments",append=FALSE)
            )
   }
)
output$allComments <- DT::renderDT({
   da <- rvAllComments()
   b <- DT::datatable(da,rownames="",selection="single"
                     ,extensions="Scroller"
                     ,options=list(NULL
                                  ,ordering=F
                                  ,scroller=T
                                  ,scrollY="calc(100vh - 240px)"
                                  ,scrollX=FALSE
                                  ,pageLength=nrow(da)
                                  ,dom="ift"
                                 # ,dom="iftlp"
                                 # ,pageLength=6,lengthMenu=c(4,5,6,8,10,15,20)
                                 )
                     )
   b
})
output$onlyCommentButton <- renderUI({
   onlyCommentButton()
})
```

## {data-width=120}

### NAC Multipliers

```{r}
conditionalPanel(condition="!!output.admin",{
   fillCol(flex=NA
      ,sliderInput("mulNAR",label="Multiplyer for red cells"
                  ,min=0,max=100,step=1,value=config$concern[1]
                  )
      ,sliderInput("mulNAY",label="Multiplyer for yellow cells"
                 ,min=0,max=100,step=1,value=config$concern[2]
                 )
      ,sliderInput("mulNAG",label="Multiplyer for green cells"
                 ,min=0,max=100,step=1,value=config$concern[3]
                 )
      ,if (F) {
         actionLink("rebuildNAC","Apply changes")
         br()
         HTML("Application will be restarted with initialization during 1-2 mins.")
      }
   )
})
```

### Misc {data-height="auto"}

:::dropup

```{r}
condAdmin <- "!!output.admin"
condAuthorized <- "!!output.authorized"
fillCol(flex=NA
   ,conditionalPanel(condition=condAdmin
      ,fillRow(flex=NA
         ,checkboxInput("relative","Relative NAC?",value=config$relative,width="108px")
         ,checkboxInput("comment","Comments?",value=config$comment,width="92px")
         ,downloadLink("downloadComment","Download comments")
      )
   )
   ,conditionalPanel(condition=condAdmin # "2==2 || input.industry!='none' || input.economy!='none'"
         ,selectInput("coloring","Colorization",unname(methodList)
                   # ,selected=grep("overlap",methodList,value=TRUE)
                    ,width="342px"
                    )
   )
   ,conditionalPanel(condition="!!output.admin & !!output.debug"
      ,sliderInput("sleepValue",label="Pausing Value, ms"
                  ,min=0,max=1000,step=10,value=config$sleepValue
                  )
   )
)
```
:::
